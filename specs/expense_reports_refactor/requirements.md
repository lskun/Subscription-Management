# 需求文档（Expense Reports 口径统一与性能优化）

## 介绍

将 `expense-reports` Edge Function 的计算口径统一为“实际支付流水 payment_history(status='success')”，并在不改变前端调用与响应结构的前提下，优化性能（SQL 下推聚合、减少往返与 JS 循环）与可维护性。按“最大复用原则”复用已有查询模式、汇率获取逻辑（最新汇率口径）、网关与缓存能力。保留既有“硬编码年份逻辑”对 2023 年的处理。

## 需求

### 需求 1 - 统一金额口径为实际支付流水

**用户故事：** 作为用户，我希望报表各项金额都来自我真实产生的支付流水（并按目标货币换算），以便对账一致。

#### 验收标准（ERAS）
1. When 用户选择时间区间, the 系统 shall 基于 `payment_history(status='success')` 聚合金额，忽略非成功支付。
2. While 记录币种与目标币种不同, the 系统 shall 采用“最新汇率”进行 from→CNY→target 的双段换算。
3. While 前端只打开部分开关（如仅月度）, the 系统 shall 仅返回对应部分，响应结构不变。

### 需求 2 - 趋势卡片（Monthly/Quarterly/Yearly）金额、次数与真实支付一致

**用户故事：** 作为用户，我希望趋势卡片的金额、支付次数都与真实支付一致，并能看到与上一期的变化率。

#### 验收标准（ERAS）
1. When 请求趋势数据, the 系统 shall 以对应粒度（月/季/年）对真实支付流水聚合金额与支付次数。
2. While 上一期金额大于 0, the 系统 shall 返回变化率 = (本期-上期)/上期；否则变化率返回 0。

### 需求 3 - 按分类统计（Spending by Category）按真实支付归类

**用户故事：** 作为用户，我希望分类统计以实际支付金额归属到支付对应的订阅分类，未分类归入 other。

#### 验收标准（ERAS）
1. When 订阅存在分类, the 系统 shall 将支付归入对应分类；否则归入 `other`。
2. While 分类无支付, the 系统 shall 返回 total=0 且可不出现在列表或置末尾（按总额降序）。

### 需求 4 - 性能目标

**用户故事：** 作为用户，我希望报表快速返回，确保体验流畅。

#### 验收标准（ERAS）
1. While 正常数据量（近 12 个月、1-3 千条支付）, when 请求完整报表, the 系统 shall P95 < 300ms（Edge 端处理时长）。
2. When 请求完整报表, the 系统 shall 数据库往返 ≤ 3 次（或 1-2 次并行）；无不必要字段。

### 需求 5 - 最大复用原则

**用户故事：** 作为维护者，我希望尽量复用现有能力，降低改造成本并减少回归风险。

#### 验收标准（ERAS）
1. While 汇率换算, the 系统 shall 复用“最新汇率快照”的口径与查询思路（与 Dashboard 一致）。
2. While 调用后端, the 前端 shall 继续复用现有 `supabaseGateway.invokeFunction` 与请求 DTO/响应结构。
3. When 清理/缓存, the 系统 shall 复用现有缓存策略（仅在必要处新增短 TTL 内存缓存）。

### 需求 6 - 保留硬编码年份逻辑

**用户故事：** 作为产品，我需要在报表中保留 2023 年的特殊规则以兼容既有展现。

#### 验收标准（ERAS）
1. While 统计年度与分类, when 年份为 2023, the 系统 shall 将对应金额置 0（即使存在真实支付）。
2. While 统计月度与季度, the 系统 shall 不引入额外年份硬编码，保持现状。
