# Implementation Plan

- [x] 1. 创建核心数据获取函数
  - 实现优化的汇率查询函数，只获取最新日期的汇率数据
  - 实现单次支付记录查询函数，获取最近3年的所有支付记录
  - 添加错误处理和数据验证逻辑
  - _Requirements: 1.1, 2.1, 4.1_

- [x] 2. 实现支付记录分组逻辑
  - 创建日期分类器类，支持月、季度、年的分类
  - 实现支付记录按时间段分组的核心函数
  - 添加边界情况处理（无效日期、空数据等）
  - _Requirements: 2.2, 1.2_

- [x] 3. 重构统计计算逻辑
  - 基于分组数据计算月度、季度、年度统计信息
  - 实现支付次数统计功能
  - 保持与现有数据结构的完全兼容性
  - _Requirements: 1.3, 3.2_

- [x] 4. 集成新逻辑到 Edge Function
  - 替换现有的多次查询逻辑为单次查询逻辑
  - 更新 expenseInfo 计算部分使用新的分组和统计函数
  - 确保 API 响应格式保持不变
  - _Requirements: 1.1, 1.3, 3.1_

- [ ] 5. 添加性能监控和日志
  - 添加查询执行时间监控
  - 添加数据处理步骤的详细日志
  - 实现查询失败的降级处理
  - _Requirements: 4.2, 2.3_

- [ ] 6. 编写单元测试
  - 测试日期分类器的正确性
  - 测试支付记录分组逻辑
  - 测试统计计算的准确性
  - _Requirements: 3.3, 2.3_

- [ ] 7. 编写集成测试
  - 测试完整的 API 响应格式和数据准确性
  - 测试与前端 ExpenseInfoCards 组件的兼容性
  - 测试不同时间范围和货币的处理
  - _Requirements: 3.1, 3.2, 1.3_

- [ ] 8. 部署、测试和验证
  - 使用 supabase mcp 部署优化后的 Edge Function
  - 使用 playwright mcp 进行页面功能测试和验证
  - 对比优化前后的响应时间和性能指标
  - 验证费用报告页面的数据准确性和加载速度
  - 监控数据库查询次数的减少效果
  - _Requirements: 3.1, 4.1, 4.2, 4.3_